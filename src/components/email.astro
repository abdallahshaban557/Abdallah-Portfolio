---
export const prerender = false;

import { Resend } from 'resend';

let formSubmissionStatus = '';

if (Astro.request.method === 'POST') {
	console.log('form is trying to be submitted - 0');
	try {
		console.log('form is trying to be submitted - 1');
		const resend = new Resend(import.meta.env.RESEND_API_KEY);
		const data = await Astro.request.formData();
		const name = data.get('name');
		const email = data.get('email');
		const message = data.get('message');
		console.log('form is trying to be submitted - 2');
		const sendResend = await resend.emails.send({
			from: 'contact@abdallahshaban.com',
			to: 'abdallah.w.shaban@gmail.com',
			subject: `Submission from ${name}`,
			replyTo: email as string,
			html: `<p>Hi Abdallah,</p><p>You got an email from ${name}.<br> Their email is ${email}.</p><p>Message: ${message}</p>`,
		});

		if (sendResend.data) {
			console.log('message sent');
			formSubmissionStatus = 'success';
		} else {
			console.log('message failed to send');
			formSubmissionStatus = 'error';
		}
	} catch (error) {
		if (error instanceof Error) {
			console.error(error.message);
			formSubmissionStatus = 'error';
		}
	}
}
---

<div id="email-container">
	<form id="email-form" method="POST" class="w-full max-w-3xl">
		<div class="mb-4">
			<label for="name" class="mb-2 block text-sm font-bold text-black dark:text-white">
				Name:
			</label>
			<input
				type="text"
				name="name"
				id="name"
				required
				class="w-full rounded-xl border-2 border-orange bg-white px-3 py-2 text-sm text-black focus:border-orange focus:outline-none focus:ring-2 focus:ring-orange dark:bg-black dark:text-white"
				placeholder="Your name"
			/>
		</div>
		<div class="mb-4">
			<label for="email" class="mb-2 block text-sm font-bold text-black dark:text-white">
				Email:
			</label>
			<input
				type="email"
				name="email"
				id="email"
				required
				class="w-full rounded-xl border-2 border-orange bg-white px-3 py-2 text-sm text-black focus:border-orange focus:outline-none focus:ring-2 focus:ring-orange dark:bg-black dark:text-white"
				placeholder="Your email address"
			/>
		</div>
		<div class="mb-4">
			<label for="message" class="mb-2 block text-sm font-bold text-black dark:text-white">
				Message:
			</label>
			<textarea
				name="message"
				id="message"
				required
				rows="4"
				class="w-full rounded-xl border-2 border-orange bg-white px-3 py-2 text-sm text-black focus:border-orange focus:outline-none focus:ring-2 focus:ring-orange dark:bg-black dark:text-white"
			></textarea>
		</div>
		<div class="flex justify-center">
			<button
				type="submit"
				class="rounded-xl bg-orange px-4 py-2 text-sm font-bold text-white transition duration-300 hover:bg-black dark:hover:bg-white dark:hover:text-black"
			>
				Send message
			</button>
		</div>
	</form>
	<div id="success-message" class={formSubmissionStatus === 'success' ? '' : 'hidden'}>
		<p>Thank you for your message. It has been sent successfully!</p>
	</div>
	<div id="error-message" class={formSubmissionStatus === 'error' ? '' : 'hidden'}>
		<p>There was an error sending your message. Please try again.</p>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const form = document.getElementById('email-form');
		const successMessage = document.getElementById('success-message');
		const errorMessage = document.getElementById('error-message');

		form?.addEventListener('submit', async (e) => {
			e.preventDefault();

			if (!(form instanceof HTMLFormElement)) {
				console.error('Form is not an HTMLFormElement');
				return;
			}

			const formData = new FormData(form);

			try {
				const response = await fetch('', {
					method: 'POST',
					body: formData,
				});

				if (response.ok) {
					form.reset();
					successMessage?.classList.remove('hidden');
					errorMessage?.classList.add('hidden');
				} else {
					throw new Error('Form submission failed');
				}
			} catch (error) {
				console.error('Error:', error);
				errorMessage?.classList.remove('hidden');
				successMessage?.classList.add('hidden');
			}
		});
	});
</script>
